<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¿»è¯‘ç­”é¢˜é¡µé¢</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif;
        }
        body {
            background-color: #fff;
            padding: 20px;
            padding-bottom: 120px;
            min-height: 100vh;
        }
        button, button:focus, button:active, button:hover {
            outline: none !important;
            -webkit-tap-highlight-color: transparent !important;
            user-select: none !important;
            -webkit-user-select: none !important;
        }
        .close-btn {
            font-size: 24px;
            color: #ccc;
            background: none;
            border: none;
            cursor: pointer;
        }
        .progress-bar {
            flex: 1;
            height: 12px;
            background-color: #eee;
            border-radius: 6px;
            overflow: hidden;
            margin: 0 10px;
        }
        .progress-fill {
            height: 100%;
            width: 25%;
            background-color: #4CAF50;
            border-radius: 6px;
        }
        .page-title {
            font-size: 24px;
            color: #333;
            margin: 20px 0;
        }
        .avatar-area {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
        }
        .dialog-box {
            padding: 12px 20px;
            background-color: #fff;
            border: 2px solid #eee;
            border-radius: 20px;
            font-size: 18px;
            color: #333;
        }
        .answer-area {
            display: flex;
            gap: 12px;
            margin: 0 auto 30px;
            min-height: 50px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 12px;
            max-width: 90%;
            flex-wrap: wrap;
        }
        .word-btn {
            padding: 10px 12px;
            border-radius: 20px;
            background-color: #d7ffb8;
            border: 2px solid #b8f18d;
            color: #6aae22;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 3px 0 #b8f18d;
        }
        .word-btn:active {
            box-shadow: none;
            top: 3px;
        }
        .candidate-area {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 0 auto;
            max-width: 90%;
        }
        .candidate-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            min-height: 42px;
        }
        .candidate-item {
            padding: 0;
            margin: 0;
            height: 42px;
        }
        .candidate-btn {
            padding: 10px 12px;
            border-radius: 20px;
            background-color: #fff;
            border: 2px solid #eee;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 3px 0 #eee;
            box-sizing: border-box; /* ç¡®ä¿paddingå’ŒborderåŒ…å«åœ¨å…ƒç´ çš„æ€»å®½åº¦å†… */
            min-width: 60px;
            text-align: center;
        }
        .candidate-btn:active {
            box-shadow: none;
            top: 3px;
        }
        .candidate-placeholder {
            padding: 10px 12px;
            border-radius: 20px;
            background-color: #f5f5f5;
            border: 2px dashed #eee;
            color: transparent;
            display: none;
            box-sizing: border-box; /* ç¡®ä¿paddingå’ŒborderåŒ…å«åœ¨å…ƒç´ çš„æ€»å®½åº¦å†… */
            min-width: 60px;
            text-align: center;
        }
        .bottom-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            background-color: #fff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .tip-bar {
            background-color: #f0fce0;
            padding: 10px;
            display: flex;
            align-items: center;
            border-radius: 8px;
            display: none;
        }
        .tip-icon {
            color: #4CAF50;
            font-size: 20px;
            margin-right: 10px;
        }
        .tip-text {
            font-size: 18px;
            color: #4CAF50;
        }
        .action-btn {
            width: 100%;
            padding: 15px;
            background-color: #4CAF50;
            color: #fff;
            font-size: 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 4px 0 #388E3C;
        }
        .action-btn:active {
            box-shadow: none;
            top: 4px;
        }
        
        /* è¿›åº¦æç¤ºå¼¹çª—æ ·å¼ */
        .progress-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .progress-modal-content {
            background-color: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .progress-modal-title {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .progress-modal-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .progress-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .progress-modal-button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .progress-modal-button:hover {
            filter: brightness(1.05);
        }
        
        .progress-modal-button:active {
            transform: translateY(2px);
        }
        
        .progress-modal-button.restart {
            background-color: #fff;
            color: #4CAF50;
            border: 2px solid #4CAF50;
            box-shadow: 0 3px 0 #4CAF50;
        }
        
        .progress-modal-button.restart:active {
            box-shadow: none;
        }
        
        .progress-modal-button.continue,
        .progress-modal-button.go-to-banks {
            background-color: #4CAF50;
            color: #fff;
            box-shadow: 0 3px 0 #388E3C;
        }
        
        .progress-modal-button.continue:active,
        .progress-modal-button.go-to-banks:active {
            box-shadow: none;
        }
        /* === æ–°å¢æ ·å¼ï¼šé¢˜åº“æŒ‰é’® & å¼¹çª— === */
        .question-bank-btn {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: #fff;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 3px 0 #388E3C;
            margin-left: 10px;
        }
        .question-bank-btn:active {
            box-shadow: none;
            top: 3px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .candidate-btn, .candidate-placeholder, .word-btn {
                font-size: 14px;
                padding: 8px 10px;
            }
            
            .candidate-row {
                gap: 8px;
            }
            
            .answer-area {
                gap: 8px;
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .candidate-btn, .candidate-placeholder, .word-btn {
                font-size: 12px;
                padding: 6px 8px;
            }
            
            .candidate-row {
                gap: 6px;
            }
            
            .answer-area {
                gap: 6px;
                padding: 8px;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            .dialog-box {
                font-size: 16px;
                padding: 10px 15px;
            }
        }
        .bank-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .bank-modal {
            background-color: #fff;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .modal-title {
            font-size: 20px;
            color: #333;
        }
        .modal-close {
            font-size: 24px;
            color: #ccc;
            background: none;
            border: none;
            cursor: pointer;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-section {
            margin-bottom: 15px;
        }
        .section-title {
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }
        .file-input-container {
            position: relative;
            margin-bottom: 10px;
        }
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .file-input-label {
            display: block;
            padding: 12px;
            background-color: #f5f5f5;
            border: 2px dashed #eee;
            border-radius: 8px;
            text-align: center;
            color: #999;
            cursor: pointer;
        }
        .template-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .question-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
        .question-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .question-text {
            font-size: 14px;
            color: #333;
        }
        .question-actions {
            display: flex;
            gap: 5px;
        }
        .action-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            color: #666;
            cursor: pointer;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            position: relative;
        }
        .btn-primary {
            background-color: #4CAF50;
            color: #fff;
            box-shadow: 0 3px 0 #388E3C;
        }
        .btn-primary:active {
            box-shadow: none;
            top: 3px;
        }
        .btn-secondary {
            background-color: #f5f5f5;
            color: #333;
            box-shadow: 0 3px 0 #eee;
        }
        .btn-secondary:active {
            box-shadow: none;
            top: 3px;
        }
    </style>
</head>
<body>
<!-- é¡¶éƒ¨åŒºåŸŸ -->
<div style="display: flex; align-items: center;">
    <div class="progress-bar">
        <div class="progress-fill"></div>
    </div>
    <button class="question-bank-btn" id="questionBankBtn">é¢˜åº“</button>
</div>
<!-- æ ‡é¢˜ -->
<div class="page-title">ç¿»è¯‘è¿™å¥è¯</div>
<!-- å¯¹è¯æ¡†åŒºåŸŸ -->
<div class="avatar-area">
    <div class="dialog-box" id="questionDialog">ä½ çˆ±è¿åŠ¨å—ï¼Ÿ</div>
</div>
<!-- ç­”é¢˜åŒº -->
<div class="answer-area" id="answerArea"></div>
<!-- å€™é€‰åŒº -->
<div class="candidate-area" id="candidateArea">
    <!-- å°†ç”± JavaScript åŠ¨æ€ç”Ÿæˆå€™é€‰å•è¯ -->
</div>
<!-- åº•éƒ¨æ“ä½œåŒº -->
<div class="bottom-area">
        <div class="tip-bar" id="tipBar">
            <div class="tip-icon">âœ”</div>
            <div class="tip-text">å¥½æ£’ï¼</div>
        </div>
        <!-- å®Œæˆæç¤ºåŒº -->
        <div class="completion-area" id="completionArea" style="display: none; text-align: center; padding: 20px;">
            <p style="font-size: 18px; margin-bottom: 20px;">æ­å–œä½ å®Œæˆäº†æ‰€æœ‰çš„é¢˜ç›®ï¼Œä½ å¯ä»¥ç‚¹å‡»é‡æ–°å¼€å§‹æˆ–åˆ‡æ¢é¢˜åº“</p>
            <img src="image.png" alt="å®Œæˆå›¾ç‰‡" style="max-width: 200px; height: auto; margin-bottom: 20px;">
            <button class="action-btn" id="restartBtn">é‡æ–°å¼€å§‹</button>
        </div>
        <button class="action-btn" id="mainBtn">æ£€æŸ¥</button>
    </div>
    
    <!-- è¿›åº¦æç¤ºå¼¹çª— -->
    <div class="progress-modal" id="progressModal" style="display: none;">
        <div class="progress-modal-content">
            <h3 class="progress-modal-title" id="progressModalTitle">æ£€æµ‹åˆ°æœªå®Œæˆè¿›åº¦</h3>
            <p class="progress-modal-text" id="progressModalText">æ£€æµ‹åˆ°ä¸Šä¸€æ¬¡æœªå®Œæˆçš„è¿›åº¦ï¼Œæ˜¯ç»§ç»­è¿˜æ˜¯é‡æ–°å¼€å§‹ï¼Ÿ</p>
            <div class="progress-modal-buttons">
                <button class="progress-modal-button restart" id="restartProgressBtn">é‡æ–°å¼€å§‹</button>
                <button class="progress-modal-button continue" id="continueProgressBtn">ç»§ç»­ä¸Šä¸€æ¬¡</button>
                <button class="progress-modal-button go-to-banks" id="goToBanksBtn" style="display: none;">è¿›å…¥é¢˜åº“é¡µé¢</button>
            </div>
        </div>
    </div>
<!-- é¢˜åº“å¼¹çª— -->
<div class="bank-modal-overlay" id="bankModalOverlay">
    <div class="bank-modal">
        <div class="modal-header">
            <h3 class="modal-title">é¢˜åº“ç®¡ç†</h3>
            <button class="modal-close" id="modalCloseBtn">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="modal-section">
                <h4 class="section-title">å¯¼å…¥é¢˜åº“</h4>
                <p class="template-desc">
                    æ¨¡æ¿æ ¼å¼ï¼š<br>
                    ç¬¬ä¸€è¡Œç¬¬ä¸€æ ¼ä¸ºæ ‡é¢˜ï¼ˆå¯ç©ºï¼‰ï¼Œç¬¬äºŒæ ¼ä¸ºç­”æ¡ˆè¯´æ˜ï¼›<br>
                    åç»­æ¯è¡Œï¼šç¬¬ä¸€åˆ—ä¸ºä¸­æ–‡å¥å­ï¼Œç¬¬äºŒåˆ—ä¸ºè‹±æ–‡ç­”æ¡ˆï¼ˆå•è¯é—´ç©ºæ ¼åˆ†éš”ï¼‰
                </p>
                <div class="file-input-container">
                    <label for="fileInput" class="file-input-label">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</label>
                    <input type="file" class="file-input" id="fileInput" accept=".txt" />
                </div>
            </div>
            <div class="modal-section">
                <h4 class="section-title">é¢˜åº“åˆ—è¡¨</h4>
                <div class="question-list" id="questionList">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn btn-secondary" id="modalCancelBtn">å–æ¶ˆ</button>
            <button class="modal-btn btn-primary" id="modalSaveBtn">ä¿å­˜</button>
        </div>
    </div>
</div>
<script>
    // å½“å‰é¢˜ç›®ä¸ç­”æ¡ˆ
    let currentQuestion = "ä½ çˆ±è¿åŠ¨å—ï¼Ÿ";
    let correctAnswer = [];
    // é¢˜åº“æ•°æ®
    let questionBank = [];
    
    // è¿›åº¦ç®¡ç†ç›¸å…³å¸¸é‡
    const PROGRESS_STORAGE_KEY = 'questionProgress';
    
    // è¿›åº¦æ•°æ®ç»“æ„
    // {
    //   bankId: 'string', // é¢˜åº“æ ‡è¯†
    //   currentIndex: number, // å½“å‰é¢˜ç›®ç´¢å¼•
    //   completionStatus: 'in_progress' | 'completed', // å®ŒæˆçŠ¶æ€
    //   lastSaved: timestamp // æœ€åä¿å­˜æ—¶é—´
    // }
    
    // è·å–å½“å‰é¢˜åº“çš„å”¯ä¸€æ ‡è¯†
    function getCurrentBankId() {
        // ä½¿ç”¨é¢˜åº“å†…å®¹çš„ç®€å•å“ˆå¸Œä½œä¸ºå”¯ä¸€æ ‡è¯†
        const bankContent = JSON.stringify(questionBank.map(q => q.answer));
        let hash = 0;
        for (let i = 0; i < bankContent.length; i++) {
            const char = bankContent.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }
        return `bank_${hash}`;
    }
    
    // ä¿å­˜è¿›åº¦
    function saveProgress(isCompleted = null) {
        try {
            // å¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šå®ŒæˆçŠ¶æ€ï¼Œåˆ™æ ¹æ®å½“å‰ç´¢å¼•åˆ¤æ–­
            let completionStatus;
            if (isCompleted !== null) {
                completionStatus = isCompleted ? 'completed' : 'in_progress';
            } else {
                completionStatus = currentQuestionIndex === questionBank.length - 1 ? 'completed' : 'in_progress';
            }
            
            const progressData = {
                bankId: getCurrentBankId(),
                currentIndex: currentQuestionIndex,
                completionStatus: completionStatus,
                lastSaved: Date.now()
            };
            
            localStorage.setItem(PROGRESS_STORAGE_KEY, JSON.stringify(progressData));
            console.log('è¿›åº¦å·²ä¿å­˜:', progressData);
        } catch (error) {
            console.error('ä¿å­˜è¿›åº¦å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½è¿›åº¦
    function loadProgress() {
        try {
            const savedProgress = localStorage.getItem(PROGRESS_STORAGE_KEY);
            if (savedProgress) {
                const progressData = JSON.parse(savedProgress);
                const currentBankId = getCurrentBankId();
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰é¢˜åº“çš„è¿›åº¦
                if (progressData.bankId === currentBankId) {
                    return progressData;
                }
            }
        } catch (error) {
            console.error('åŠ è½½è¿›åº¦å¤±è´¥:', error);
        }
        return null;
    }
    
    // æ¸…é™¤è¿›åº¦
    function clearProgress() {
        try {
            localStorage.removeItem(PROGRESS_STORAGE_KEY);
            console.log('è¿›åº¦å·²æ¸…é™¤');
        } catch (error) {
            console.error('æ¸…é™¤è¿›åº¦å¤±è´¥:', error);
        }
    }
    
    // æ˜¾ç¤ºè¿›åº¦æç¤ºå¼¹çª—
    function showProgressModal() {
        const progressData = loadProgress();
        const modal = document.getElementById('progressModal');
        const title = document.getElementById('progressModalTitle');
        const text = document.getElementById('progressModalText');
        const continueBtn = document.getElementById('continueProgressBtn');
        const goToBanksBtn = document.getElementById('goToBanksBtn');
        
        if (progressData) {
            if (progressData.completionStatus === 'completed') {
                // å·²å®Œæˆå…¨éƒ¨é¢˜ç›®çš„æƒ…å†µ
                title.textContent = 'å·²å®Œæˆå…¨éƒ¨é¢˜ç›®';
                text.textContent = 'æ£€æµ‹åˆ°ä½ ä¸Šæ¬¡å·²å®Œæˆè¯¥é¢˜åº“æ‰€æœ‰é¢˜ç›®ï¼Œæ˜¯é‡æ–°å¼€å§‹ï¼Œè¿˜æ˜¯åˆ‡æ¢é¢˜åº“ï¼Ÿ';
                continueBtn.style.display = 'none';
                goToBanksBtn.style.display = 'inline-block';
            } else {
                // æœªå®Œæˆçš„æƒ…å†µ
                title.textContent = 'æ£€æµ‹åˆ°æœªå®Œæˆè¿›åº¦';
                text.textContent = 'æ£€æµ‹åˆ°ä¸Šä¸€æ¬¡æœªå®Œæˆçš„è¿›åº¦ï¼Œæ˜¯ç»§ç»­è¿˜æ˜¯é‡æ–°å¼€å§‹ï¼Ÿ';
                continueBtn.style.display = 'inline-block';
                goToBanksBtn.style.display = 'none';
            }
            
            modal.style.display = 'flex';
            return true;
        }
        
        return false;
    }
    
    // éšè—è¿›åº¦æç¤ºå¼¹çª—
    function hideProgressModal() {
        const modal = document.getElementById('progressModal');
        modal.style.display = 'none';
    }
    
    // ç»§ç»­ä¸Šä¸€æ¬¡è¿›åº¦
    function continueLastProgress() {
        const progressData = loadProgress();
        if (progressData && progressData.completionStatus === 'in_progress') {
            currentQuestionIndex = progressData.currentIndex;
            const question = questionBank[currentQuestionIndex];
            currentQuestion = question.question;
            correctAnswer = question.answer.split(' ').filter(w => w);
            renderQuestion();
            updateProgressBar();
            console.log('å·²ç»§ç»­ä¸Šä¸€æ¬¡è¿›åº¦ï¼Œå½“å‰é¢˜ç›®ç´¢å¼•:', currentQuestionIndex);
        }
        hideProgressModal();
    }
    
    // é‡æ–°å¼€å§‹
    function restart() {
        clearProgress();
        currentQuestionIndex = 0;
        const firstQuestion = questionBank[0];
        currentQuestion = firstQuestion.question;
        correctAnswer = firstQuestion.answer.split(' ').filter(w => w);
        renderQuestion();
        updateProgressBar();
        
        // éšè—ç›¸å…³ç•Œé¢å…ƒç´ 
        hideProgressModal();
        document.getElementById('completionArea').style.display = 'none';
        document.getElementById('mainBtn').style.display = 'block';
        document.getElementById('mainBtn').textContent = 'æ£€æŸ¥';
        document.getElementById('tipBar').style.display = 'none';
        
        console.log('å·²é‡æ–°å¼€å§‹');
    }
    
    // ä» localStorage åŠ è½½é¢˜åº“æ•°æ®
    function loadQuestionBankFromStorage() {
        const QUESTION_BANKS_KEY = 'questionBanks';
        const CURRENT_BANK_KEY = 'currentBank';
        
        try {
            const storedBanks = localStorage.getItem(QUESTION_BANKS_KEY);
            const currentBankName = localStorage.getItem(CURRENT_BANK_KEY) || 'é»˜è®¤é¢˜åº“';
            
            console.log('ä»localStorageè·å–çš„æ•°æ®:', storedBanks);
            console.log('å½“å‰é¢˜åº“åç§°:', currentBankName);
            
            if (storedBanks) {
                const banks = JSON.parse(storedBanks);
                console.log('è§£æåçš„é¢˜åº“æ•°æ®:', banks);
                if (banks[currentBankName] && banks[currentBankName].length > 0) {
                    // è½¬æ¢é¢˜åº“æ ¼å¼ä»¥é€‚é…ç°æœ‰ä»£ç 
                    questionBank = banks[currentBankName].map(item => ({
                        question: item.hint || item.correctSentence,
                        answer: item.correctSentence
                    }));
                    console.log('è½¬æ¢åçš„é¢˜åº“:', questionBank);
                    return true;
                }
            }
        } catch (error) {
            console.error('åŠ è½½é¢˜åº“æ•°æ®å‡ºé”™:', error);
        }
        return false;
    }
    // æ‰€æœ‰å€™é€‰è¯ä½ç½®æ˜ å°„
    const wordPositions = {};
    // åˆå§‹åŒ–å‡½æ•°
    function init() {
        // å°è¯•ä» localStorage åŠ è½½é¢˜åº“æ•°æ®
        if (loadQuestionBankFromStorage()) {
            // å¦‚æœæˆåŠŸåŠ è½½ï¼Œä½¿ç”¨ç¬¬ä¸€é¢˜ä½œä¸ºå½“å‰é¢˜ç›®
            if (questionBank.length > 0) {
                const firstQuestion = questionBank[0];
                currentQuestion = firstQuestion.question;
                correctAnswer = firstQuestion.answer.split(' ').filter(w => w);
            }
        }
        renderQuestion();
        initEventListeners();
        updateQuestionList(); // æ¸²æŸ“åˆå§‹é¢˜åº“
    }
    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    function initEventListeners() {
        document.getElementById('questionBankBtn').addEventListener('click', () => {
            window.location.href = 'questions.html';
        });
        document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
        document.getElementById('modalCancelBtn').addEventListener('click', closeModal);
        document.getElementById('bankModalOverlay').addEventListener('click', e => {
            if (e.target === document.getElementById('bankModalOverlay')) closeModal();
        });
        // æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('fileInput').addEventListener('change', handleFileImport);
        // ä¿å­˜é¢˜åº“
        document.getElementById('modalSaveBtn').addEventListener('click', saveQuestionBank);
    }
    // å…³é—­æ¨¡æ€æ¡†
    function closeModal() {
        document.getElementById('bankModalOverlay').style.display = 'none';
        document.getElementById('fileInput').value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
    }
    // å¤„ç†æ–‡ä»¶å¯¼å…¥
    function handleFileImport(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const content = event.target.result;
            const lines = content.split('\n').map(line => line.trim()).filter(Boolean);
            const imported = [];
            for (let i = 0; i < lines.length; i++) {
                // é¦–å…ˆå°è¯•é€—å·åˆ†éš”
                let cols = lines[i].split(',');
                // å¦‚æœæ²¡æœ‰é€—å·ï¼Œåˆ™æŒ‰ç©ºæ ¼åˆ†å‰²
                if (cols.length < 2) {
                    cols = lines[i].split(/\s+/);
                }
                
                // å–ç¬¬ä¸€ä¸ªä¸ºé—®é¢˜ï¼Œå…¶ä½™éƒ¨åˆ†ç»„åˆä¸ºç­”æ¡ˆ
                if (cols.length >= 2) {
                    const q = cols[0]?.trim();
                    const a = cols.slice(1).join(' ').trim();
                    if (q && a) {
                        imported.push({ question: q, answer: a });
                    }
                }
            }
            if (imported.length > 0) {
                questionBank = imported;
                currentQuestionIndex = 0; // é‡ç½®é¢˜ç›®ç´¢å¼•
                const firstQuestion = questionBank[0];
                currentQuestion = firstQuestion.question;
                correctAnswer = firstQuestion.answer.split(' ').filter(w => w);
                updateQuestionList();
                renderQuestion();
                updateProgressBar(); // æ›´æ–°è¿›åº¦æ¡
            } else {
                alert("æœªæ£€æµ‹åˆ°æœ‰æ•ˆé¢˜ç›®ï¼Œè¯·æ£€æŸ¥æ ¼å¼ï¼");
            }
        };
        reader.readAsText(file);
    }
    // æ›´æ–°é¢˜åº“åˆ—è¡¨ï¼ˆåŠ¨æ€æ¸²æŸ“ï¼‰
    function updateQuestionList() {
        const container = document.getElementById('questionList');
        container.innerHTML = '';
        questionBank.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'question-item';
            const textSpan = document.createElement('span');
            textSpan.className = 'question-text';
            textSpan.textContent = `${item.question} - ${item.answer}`;
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'question-actions';
            const editBtn = document.createElement('button');
            editBtn.className = 'action-icon';
            editBtn.textContent = 'âœï¸';
            editBtn.dataset.index = index;
            editBtn.addEventListener('click', () => useQuestion(index));
            const delBtn = document.createElement('button');
            delBtn.className = 'action-icon';
            delBtn.textContent = 'ğŸ—‘ï¸';
            delBtn.dataset.index = index;
            delBtn.addEventListener('click', () => deleteQuestion(index));
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(delBtn);
            div.appendChild(textSpan);
            div.appendChild(actionsDiv);
            container.appendChild(div);
        });
    }
    // ä½¿ç”¨æŸä¸€é“é¢˜
    function useQuestion(index) {
        currentQuestionIndex = index; // æ›´æ–°å½“å‰é¢˜ç›®ç´¢å¼•
        const item = questionBank[index];
        currentQuestion = item.question;
        correctAnswer = item.answer.split(' ').filter(w => w);
        renderQuestion();
        updateProgressBar(); // æ›´æ–°è¿›åº¦æ¡
        closeModal();
    }
    // åˆ é™¤é¢˜ç›®
    function deleteQuestion(index) {
        if (confirm("ç¡®å®šåˆ é™¤è¿™é“é¢˜å—ï¼Ÿ")) {
            questionBank.splice(index, 1);
            updateQuestionList();
        }
    }
    // ä¿å­˜é¢˜åº“ï¼ˆç›®å‰å°±æ˜¯å…³é—­ï¼‰
    function saveQuestionBank() {
        closeModal();
    }
    // æ¸²æŸ“å½“å‰é¢˜ç›®å’Œå€™é€‰è¯
    function renderQuestion() {
        document.getElementById('questionDialog').textContent = currentQuestion;
        // æ¸…ç©ºå€™é€‰åŒº
        const area = document.getElementById('candidateArea');
        area.innerHTML = '';
        // æ„å»ºæ‰€æœ‰å¯èƒ½çš„å€™é€‰è¯ï¼ˆåŒ…æ‹¬æ­£ç¡®ç­”æ¡ˆå’Œå…¶ä»–å¹²æ‰°é¡¹ï¼‰
        // ä»é¢˜åº“ä¸­è·å–å¹²æ‰°è¯
        let allWords = [];
        if (questionBank.length > 1) {
            // è·å–ä¸‹ä¸€é¢˜çš„ç´¢å¼•
            const nextIndex = (currentQuestionIndex + 1) % questionBank.length;
            // ä»ä¸‹ä¸€é¢˜ä¸­è·å–å•è¯ä½œä¸ºå¹²æ‰°é¡¹
            const nextQuestionWords = questionBank[nextIndex].answer.split(' ').filter(w => w);
            allWords = [...nextQuestionWords];
        } else {
            // å¦‚æœåªæœ‰ä¸€é¢˜ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å¹²æ‰°è¯
            allWords = ["and", "from", "something", "ticket", "like", "very", "much"];
        }
        
        // å»é‡å¹¶æ’é™¤æ­£ç¡®ç­”æ¡ˆä¸­çš„è¯
        const uniqueWords = [...new Set([
            ...correctAnswer,
            ...allWords
        ])].filter(word => !correctAnswer.includes(word));
        
        const candidates = [...correctAnswer, ...uniqueWords.slice(0, 3)]; // æ­£ç¡®è¯ + å¹²æ‰°è¯
        shuffleArray(candidates);
        // åˆ†ä¸‰è¡Œå¸ƒå±€
        const rows = [[], [], []];
        for (let i = 0; i < candidates.length; i++) {
            rows[i % 3].push(candidates[i]);
        }
        rows.forEach((row, idx) => {
            const rowEl = document.createElement('div');
            rowEl.className = 'candidate-row';
            row.forEach(word => {
                const item = document.createElement('div');
                item.className = 'candidate-item';
                const btn = document.createElement('button');
                btn.className = 'candidate-btn';
                btn.dataset.word = word;
                btn.textContent = word;
                const placeholder = document.createElement('div');
                placeholder.className = 'candidate-placeholder';
                placeholder.dataset.word = word; // æ·»åŠ data-wordå±æ€§ä¾¿äºæŸ¥æ‰¾
                placeholder.textContent = word;
                item.appendChild(btn);
                item.appendChild(placeholder);
                rowEl.appendChild(item);
            });
            area.appendChild(rowEl);
        });
        // é‡æ–°åˆå§‹åŒ–å•è¯ä½ç½®
        initWordPositions();
        // é‡ç½®ç•Œé¢
        document.getElementById('answerArea').innerHTML = '';
        document.getElementById('tipBar').style.display = 'none';
        document.getElementById('mainBtn').textContent = 'æ£€æŸ¥';
    }
    // åˆå§‹åŒ–å€™é€‰è¯ä½ç½®è®°å½•
    function initWordPositions() {
        Object.keys(wordPositions).forEach(key => {
            delete wordPositions[key];
        });
        document.querySelectorAll('.candidate-btn').forEach(btn => {
            const word = btn.dataset.word;
            const parentItem = btn.parentElement;
            wordPositions[word] = {
                btn: btn,
                placeholder: parentItem.querySelector('.candidate-placeholder')
            };
        });
    }
    // Fisher-Yates æ´—ç‰Œç®—æ³•
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }
    // ç­”é¢˜åŒºäº¤äº’
    document.getElementById('candidateArea').addEventListener('click', function(e) {
        if (e.target.classList.contains('candidate-btn')) {
            const word = e.target.dataset.word;
            const pos = wordPositions[word];
            setTimeout(() => {
 pos.btn.style.display = 'none';
 pos.placeholder.style.display = 'inline-block';
                const answerBtn = document.createElement('button');
                answerBtn.className = 'word-btn selected';
                answerBtn.dataset.word = word;
                answerBtn.textContent = word;
                document.getElementById('answerArea').appendChild(answerBtn);
            }, 50);
        }
    });
    document.getElementById('answerArea').addEventListener('click', function(e) {
        if (e.target.classList.contains('word-btn')) {
            const word = e.target.dataset.word;
            const pos = wordPositions[word];
            setTimeout(() => {
 e.target.remove();
                if (pos) {
 pos.btn.style.display = 'inline-block';
 pos.placeholder.style.display = 'none';
                }
            }, 50);
        }
    });
    // å½“å‰é¢˜ç›®ç´¢å¼•
    let currentQuestionIndex = 0;
    
    // æ›´æ–°è¿›åº¦æ¡
    function updateProgressBar() {
        const progressFill = document.querySelector('.progress-fill');
        if (progressFill && questionBank.length > 0) {
            const progressPercentage = ((currentQuestionIndex + 1) / questionBank.length) * 100;
            progressFill.style.width = progressPercentage + '%';
        }
    }
    
    // æ£€æŸ¥ç­”æ¡ˆ
    document.getElementById('mainBtn').addEventListener('click', function() {
        const btn = document.getElementById('mainBtn');
        const tipBar = document.getElementById('tipBar');
        const completionArea = document.getElementById('completionArea');
        if (btn.textContent === 'æ£€æŸ¥') {
            const selectedWords = Array.from(document.getElementById('answerArea').children)
                .map(el => el.dataset.word);
            if (JSON.stringify(selectedWords) === JSON.stringify(correctAnswer)) {
                tipBar.style.display = 'flex';
                // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€é¢˜
                if (currentQuestionIndex === questionBank.length - 1) {
                    // ä¿å­˜å…¨éƒ¨å®ŒæˆçŠ¶æ€
                    saveProgress(true); // æ˜¾å¼æ ‡è®°ä¸ºå·²å®Œæˆ
                    // æœ€åä¸€é¢˜ç­”å¯¹ï¼Œæ˜¾ç¤ºå®Œæˆæç¤º
                    btn.style.display = 'none';
                    completionArea.style.display = 'block';
                } else {
                    // åœ¨æ˜¾ç¤º"å¾ˆæ£’"æç¤ºæ—¶ç«‹å³ä¿å­˜ä¸‹ä¸€é¢˜çš„ç´¢å¼•
                    const nextIndex = (currentQuestionIndex + 1) % questionBank.length;
                    // ä¸´æ—¶æ›´æ–°currentQuestionIndexä»¥ä¿å­˜ä¸‹ä¸€é¢˜ç´¢å¼•
                    const tempIndex = currentQuestionIndex;
                    currentQuestionIndex = nextIndex;
                    // ä¿å­˜è¿›åº¦ä½†ä¸æ ‡è®°ä¸ºå®Œæˆ
                    saveProgress(false);
                    // æ¢å¤currentQuestionIndexä»¥ä¾¿æ­£ç¡®åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜
                    currentQuestionIndex = tempIndex;
                    btn.textContent = 'ç»§ç»­';
                }
            } else {
                alert('ç­”æ¡ˆä¸æ­£ç¡®ï¼Œå†è¯•è¯•å§ï¼');
            }
        } else {
            // åˆ‡æ¢åˆ°ä¸‹ä¸€é¢˜
            currentQuestionIndex = (currentQuestionIndex + 1) % questionBank.length;
            const nextQuestion = questionBank[currentQuestionIndex];
            currentQuestion = nextQuestion.question;
            correctAnswer = nextQuestion.answer.split(' ').filter(w => w);
            renderQuestion();
            updateProgressBar(); // æ›´æ–°è¿›åº¦æ¡
            btn.textContent = 'æ£€æŸ¥';
            tipBar.style.display = 'none';
        }
    });
    
    // é‡æ–°å¼€å§‹æŒ‰é’®äº‹ä»¶
    document.getElementById('restartBtn').addEventListener('click', function() {
        restart();
    });
    
    // è¿›åº¦æç¤ºå¼¹çª—æŒ‰é’®äº‹ä»¶å¤„ç†
    document.getElementById('restartProgressBtn').addEventListener('click', function() {
        restart();
    });
    
    document.getElementById('continueProgressBtn').addEventListener('click', function() {
        continueLastProgress();
    });
    
    document.getElementById('goToBanksBtn').addEventListener('click', function() {
        hideProgressModal();
        window.location.href = 'questions.html';
    });
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    window.onload = function () {
        init();
        initEventListeners();
        renderQuestion();
        updateProgressBar(); // åˆå§‹åŒ–è¿›åº¦æ¡
        // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆè¿›åº¦
        showProgressModal();
        // ç¡®ä¿åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒæ•´å ä½å—å°ºå¯¸
        setTimeout(updatePlaceholderSizes, 100);
    };
    
    // æ›´æ–°æ‰€æœ‰å ä½å—çš„å°ºå¯¸ä»¥åŒ¹é…å¯¹åº”æŒ‰é’®
    function updatePlaceholderSizes() {
        const buttons = document.querySelectorAll('.candidate-btn');
        buttons.forEach(btn => {
            const word = btn.dataset.word;
            // ä½¿ç”¨æœ€è¿‘é€‰æ‹©å™¨æ‰¾åˆ°å¯¹åº”çš„å ä½å—
            const item = btn.closest('.candidate-item');
            if (item) {
                const placeholder = item.querySelector('.candidate-placeholder');
                if (placeholder) {
                    const computedStyle = window.getComputedStyle(btn);
                    placeholder.style.width = computedStyle.width;
                    placeholder.style.height = computedStyle.height;
                    placeholder.style.paddingLeft = computedStyle.paddingLeft;
                    placeholder.style.paddingRight = computedStyle.paddingRight;
                    placeholder.style.paddingTop = computedStyle.paddingTop;
                    placeholder.style.paddingBottom = computedStyle.paddingBottom;
                    placeholder.style.borderLeftWidth = computedStyle.borderLeftWidth;
                    placeholder.style.borderRightWidth = computedStyle.borderRightWidth;
                    placeholder.style.borderTopWidth = computedStyle.borderTopWidth;
                    placeholder.style.borderBottomWidth = computedStyle.borderBottomWidth;
                }
            }
        });
    }
</script>
</body>
</html>